# WordPress Database Sync Script

Скрипт для синхронизации базы данных WordPress с продакшен-сервера на локальную тестовую среду, с автоматической заменой URL и других настроек.

## Описание

Этот bash-скрипт использует WP-CLI для автоматизации процесса синхронизации базы данных WordPress между продакшен-сервером и локальной средой разработки. Скрипт выполняет следующие операции:

- Создание резервной копии локальной базы данных перед синхронизацией
- Экспорт базы данных с продакшен-сервера через SSH
- Импорт полученной базы данных в локальную среду
- Замена URL продакшен-сайта на URL локальной среды
- Обновление структуры постоянных ссылок и очистка кэша

## Требования

Для корректной работы скрипта необходимо:

- WP-CLI, установленный как на локальном компьютере, так и на продакшен-сервере
- SSH-доступ к продакшен-серверу
- Права на выполнение команд WP-CLI на обоих серверах
- Bash-терминал (Linux, macOS или WSL для Windows)

## Установка

1. Скачайте скрипт `wp-db-sync.sh`
2. Сделайте скрипт исполняемым:

```bash
chmod +x wp-db-sync.sh
```

3. Отредактируйте настройки в начале скрипта под вашу конфигурацию

## Настройка

В начале скрипта находится секция настроек, которую необходимо изменить под ваши параметры:

```bash
# Продакшен-сервер
PROD_SSH_USER="username"           # Имя пользователя SSH
PROD_SSH_HOST="example.com"        # Хост продакшен-сервера
PROD_SSH_PORT="22"                 # Порт SSH (обычно 22)
PROD_WP_PATH="/path/to/wordpress"  # Путь к WordPress на продакшен-сервере
PROD_URL="https://example.com"     # URL продакшен-сайта

# Локальная среда
LOCAL_WP_PATH="/path/to/local/wordpress"  # Путь к локальной установке WordPress
LOCAL_URL="http://localhost/wordpress"     # URL локального сайта
```

## Использование

Запустите скрипт из командной строки:

```bash
./wp-db-sync.sh
```

Скрипт выведет подробную информацию о каждом этапе синхронизации и сообщит об успешном завершении или возникших ошибках.

## Дополнительные функции

### Резервное копирование

Скрипт автоматически создает резервную копию локальной базы данных перед импортом продакшен-данных. Резервная копия сохраняется в файл с именем вида:

```
local_db_backup_YYYYMMDD_HHMMSS.sql
```

Где `YYYYMMDD_HHMMSS` — текущая дата и время.

### Замена URL

Скрипт выполняет замену URL в двух вариантах:
- Полный URL с протоколом (`https://example.com` → `http://localhost/wordpress`)
- Только домен без протокола (`example.com` → `localhost/wordpress`)

Это обеспечивает полную замену всех ссылок в базе данных.

## Возможные проблемы и их решение

### Ошибка подключения SSH

Если возникает ошибка SSH-подключения, проверьте:
- Правильность указанных данных (имя пользователя, хост, порт)
- Наличие SSH-ключа или правильность пароля
- Доступность сервера и открытость порта

### Ошибки WP-CLI

При ошибках WP-CLI проверьте:
- Установлен ли WP-CLI на обоих серверах
- Корректность путей к WordPress в настройках скрипта
- Права на выполнение WP-CLI команд на серверах

### Проблемы с базой данных

При проблемах импорта/экспорта базы данных:
- Убедитесь, что у вас достаточно прав для работы с базой данных
- Проверьте наличие свободного места на диске
- Для больших баз данных может потребоваться увеличение лимитов PHP (memory_limit, max_execution_time)

## Кастомизация скрипта

### Исключение определенных таблиц

Чтобы исключить определенные таблицы из импорта (например, таблицы статистики или логов), добавьте параметр `--exclude_tables` в команду экспорта:

```bash
wp db export - --exclude_tables=wp_statistics,wp_logs --allow-root
```

### Дополнительные замены

Для дополнительных замен в базе данных (например, пути к файлам), добавьте команды search-replace:

```bash
wp search-replace "/var/www/prod/uploads" "/local/path/uploads" --all-tables --allow-root
```

## Автоматизация

Для регулярной синхронизации данных можно настроить выполнение скрипта через cron. Пример добавления задачи для выполнения скрипта раз в неделю:

```bash
0 0 * * 0 /path/to/wp-db-sync.sh >> /path/to/sync-log.txt 2>&1
```

## Безопасность

Несколько рекомендаций по безопасности:
- Не храните скрипт с заполненными учетными данными в публичных репозиториях
- Рассмотрите использование SSH-ключей вместо паролей для аутентификации
- Создайте отдельного пользователя на продакшен-сервере с минимально необходимыми правами
- Убедитесь, что файлы с дампами базы данных недоступны из веба

## Лицензия

Данный скрипт распространяется под лицензией MIT. Вы можете свободно использовать его, модифицировать и распространять при условии сохранения информации об авторских правах.

## Контакты и поддержка

Если у вас возникли проблемы с использованием скрипта или есть предложения по улучшению, пожалуйста, создайте issue в репозитории проекта или свяжитесь с автором напрямую.
